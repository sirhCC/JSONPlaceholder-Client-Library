name: Security Audit

on:
  schedule:
    # Run daily at 02:00 UTC
    - cron: '0 2 * * *'
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  security-audit:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install dependencies
        run: |
          echo "Installing main package dependencies..."
          npm ci
          echo "Main package dependencies installed successfully"
          
      - name: Build main package for React dependencies
        run: |
          echo "Building main package..."
          npm run build
          echo "Main package built successfully"
        
      - name: Run npm audit on main package
        run: |
          echo "Running npm audit on main package..."
          npm audit --audit-level=moderate --json > audit-results.json || true
          if [ -f "audit-results.json" ]; then
            echo "📋 Main package audit results:"
            cat audit-results.json
          fi
          
      - name: Check for high/critical vulnerabilities in main package
        run: |
          echo "Checking main package for high/critical vulnerabilities..."
          if npm audit --audit-level=high --dry-run; then
            echo "✅ No high or critical vulnerabilities found in main package"
          else
            echo "❌ High or critical vulnerabilities detected in main package"
            npm audit --audit-level=high
            exit 1
          fi
          
      - name: React package security audit
        run: |
          echo "Checking if React package exists..."
          if [ -d "packages/react" ]; then
            echo "React package found, proceeding with audit..."
            cd packages/react
            echo "Installing React package dependencies..."
            npm ci --legacy-peer-deps || npm ci || true
            echo "Running React package audit..."
            npm audit --audit-level=moderate --json > react-audit-results.json || true
            if [ -f "react-audit-results.json" ]; then
              echo "📋 React package audit results:"
              cat react-audit-results.json
            else
              echo "Audit results file not created, but continuing..."
            fi
          else
            echo "React package not found, skipping React audit"
          fi
          
      - name: Check React package vulnerabilities
        run: |
          if [ -d "packages/react" ]; then
            echo "Checking React package for high/critical vulnerabilities..."
            cd packages/react
            if npm audit --audit-level=high --dry-run; then
              echo "✅ No high or critical vulnerabilities found in React package"
            else
              echo "⚠️ High or critical vulnerabilities detected in React package"
              npm audit --audit-level=high || true
              echo "React package has vulnerabilities but continuing (non-blocking)"
            fi
          else
            echo "React package not found, skipping vulnerability check"
          fi
          
      - name: Security summary
        run: |
          echo "🔒 Security Audit Summary:"
          echo "- Main package: Audited for vulnerabilities"
          echo "- React package: Audited for vulnerabilities"
          echo "- High/Critical vulnerabilities in main package will fail the build"
          echo "- React package vulnerabilities are logged but non-blocking"
          echo "✅ Security audit completed successfully"
